<BOUCLE_securite(AUTEURS) {id_auteur=#SESSION{id_auteur}} {statut=0minirezo}>
<h1><:idm:billettistes:></h1>

<?php

  function delete_billettistes() {
    $reload = false;

    if(isset($_POST['delete_billettistes'])) {
      foreach($_POST as $key=>$value) {
        if (preg_match('/^action_billettistes_([0-9]*)$/', $key, $matches)) {
          $id = intval($matches[1]);
          sql_updateq('spip_auteurs', array('billettiste'=>'non'), "id_auteur = $id");
          $reload = true;
        }
      }
    }

    if ($reload) {
      $newpost = array(
        'nom' => $_POST['nom'],
        'num' => $_POST['num'],
        'titre' => $_POST['titre']
      );
      $_POST = $newpost;
      @header ("Location: #SELF");
    }
  }

  delete_billettistes();

?>

<form action="#SELF" method="post">

  <input type="submit" value="Rechercher" style="display:none">

  <BOUCLE_toapprove(AUTEURS) {statut == .} {billettiste=non} {par nom}><!-- do NOT delete... --></BOUCLE_toapprove>
  <a href="/ecrire/?exec=idm_billettistes_attente" class="button-white go_top">Approuver de nouveaux billettistes (#TOTAL_BOUCLE en attente)</a>
  </B_toapprove>

  <div id="box_billetistes" class="box simple">

    <div class="inner">

      <div class="hd titrem">
        <h4>Rechercher par :</h4>
      </div>

      <div id="recherche_billetistes" class="bd">
        <div class="col">
          <label for="nom">Nom ou prénom :</label>
          <input type="text" name="nom" id="nom" value="#ENV{nom}">

          <label for="num">Numéro de billet :</label>
          <input type="text" name="num" id="num" value="#ENV{num}">
        </div>
        <div class="col">
          <label for="titre">Titre de l'article :</label>
          <input type="text" name="titre" id="titre" value="#ENV{titre}">

          <br>

          <input type="submit" value="Rechercher">
          <button class="empty-form">Effacer les filtres</button>
        </div>
      </div>

      <div class="bd">
        <table class="sortable" style="font-size : 90%">
          <thead><tr>
            <th><input type="checkbox" class="check_billettiste_all"></th>
            <th>ID</th>
            <th>Nom / prénom</th>
            <th>Dernier billet</th>
            <th>Billets</th>
            <th></th>
          </tr></thead>
          <tbody>
            <BOUCLE_deja(AUTEURS spip_articles) {tous} {billettiste=oui} {nom LIKE %#ENV{nom}%} {spip_articles.titre ?LIKE %#ENV{titre}%} {par nom}>
            <tr>
              <td><input type="checkbox" class="check_billettiste" name="action_billettistes_#ID_AUTEUR"></td>
              <td>#ID_AUTEUR</td>
              <td>#NOM</td>
              <BOUCLE_billet(ARTICLES) {statut=publie} {id_auteur} {id_rubrique=6} {par date} {inverse} {0,1}>
              <td><a href="#URL_ARTICLE">#TITRE ([(#DATE*|affdate)])</a></td>
              </BOUCLE_billet>
              </B_billet>
              <td>-</td>
              <//B_billet>
              <BOUCLE_nbbillet(ARTICLES) {statut=publie} {id_auteur} {id_rubrique=6}></BOUCLE_nbbillet>
              </B_nbbillet>
              <td>#TOTAL_BOUCLE</td>
              <//B_nbbillet>
              <td><a href="#URL_ECRIRE{idm_billettiste,id=#ID_AUTEUR}" class="button">Fiche</a></td>
            </tr>
            </BOUCLE_deja>
            </B_deja>
            <tr>
              <td colspan="5">Aucun billettiste ne correspond aux critères</td>
            </tr>
            <//B_deja>
          </tbody>
        </table>
      </div>

      <div class="bd">
        <input type="submit" name="delete_billettistes" class="button" value="Supprimer tous les billettistes sélectionnés">
      </div>
    </div>
  </div>

</form>

</BOUCLE_securite>
