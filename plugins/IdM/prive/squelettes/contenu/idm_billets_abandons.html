<h1><:idm:billets_abandons:></h1>

<?php function billettistes_effect_change ($target='', $caller='admin') {
  if (!$target) $target = str_replace('&amp;','&',self());

  if (!empty($_POST)) {
    foreach($_POST as $key=>$value) {

      if (preg_match('/^form_billettistes_salvage_([0-9]*)$/', $key, $matches)) {
        $id = intval($matches[1]);
        sql_updateq ('spip_articles', array('statut'=>'prepa'), "(id_article = $id) and (statut = 'tmp')");
        $reload = true;
      }

      if (preg_match('/^form_billettistes_erase_([0-9]*)$/', $key, $matches)) {
        $id = intval($matches[1]);
        sql_delete ('spip_articles', "id_article = $id");
        sql_delete ('spip_auteurs_articles', "(id_article = $id) and (statut = 'tmp')");
        $reload = true;
      }
    }

    if ($reload) {
      $_POST = array();
      @header ("Location: $target");
    }
  }
}
billettistes_effect_change ('#SELF', 'admin'); ?>

<B_bug>
<form method="post" action="#SELF">
    <table class="sortable">
        <thead>
            <tr>
                <th>id</th>
                <th>date</th>
                <th>auteur</th>
                <th>titre</th>
                <th>&Eacute;liminer</th>
                <th>R&eacute;cup&eacute;rer</th>
            </tr>
        </thead>
        <tbody>
            <BOUCLE_bug(ARTICLES) {tous} {statut=tmp}>
            <tr>
                <td>#ID_ARTICLE</td>
                <td>#DATE</td>
                <td>#LESAUTEURS</td>
                <td>#TITRE</td>
                <td><input type="checkbox" name="form_billettistes_erase_#ID_ARTICLE"/></td>
                <td><input type="checkbox" name="form_billettistes_salvage_#ID_ARTICLE"/></td>
            </tr>
            </BOUCLE_bug>
        </tbody>
    </table>

    <input type="submit" value="&Eacute;liminer ou r&eacute;cup&eacute;rer les billets indiqu&eacute;s" name="form_billettistes_go" class="button" /></p>
</form>
</B_bug>
