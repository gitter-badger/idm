<?php

    $results = sql_select(
        'id_objet',
        'spip_random',
        'type = "image_du_jour" AND date_picked >= CURDATE()'
    );
    if($row = sql_fetch($results)) {
        // L'image du jour est déjà définie aujourd'hui, on la récupère
    } else {
        // L'image du jour n'est pas encore définie, on la choisit aléatoirement
        $results = sql_select(
            'd.id_document',
            'spip_documents AS d
                JOIN spip_documents_liens AS dl ON ( dl.id_document = d.id_document )
                JOIN spip_articles AS a ON ( a.id_article = dl.id_objet AND dl.objet = "article" )
                LEFT JOIN spip_random AS r ON ( d.id_document = r.id_objet AND r.objet = "document" )',
            'r.id_objet IS NULL
                AND d.statut = "publie"
                AND a.id_article = #ARTICLE_IMAGES_DU_JOUR',
            '',
            'RAND()',
            '1'
        );
        if($row = sql_fetch($results)) {
            // On stocke l'image du jour
            sql_insertq('spip_random', array(
                'objet' => 'document',
                'id_objet' => $row['id_document'],
                'type' => 'image_du_jour',
                'date_picked' => date('Y-m-d H:i:s')
            ));
        } else {
            // Tout à été selectionné une fois, on vide les entrées de spip_random
            sql_delete('spip_random', 'type = "image_du_jour"');
            // Et on sélectionne une nouvelle figure aléatoirement
            $results = sql_select(
                'd.id_document',
                'spip_documents AS d
                    JOIN spip_documents_liens AS dl ON ( dl.id_document = d.id_document )
                    JOIN spip_articles AS a ON ( a.id_article = dl.id_objet AND dl.objet = "article" )',
                'd.statut = "publie"
                    AND a.id_article = #ARTICLE_IMAGES_DU_JOUR',
                '',
                'RAND()',
                '1'
            );
            if($row = sql_fetch($results)) {
                // On stocke l'image du jour
                sql_insertq('spip_random', array(
                    'objet' => 'document',
                    'id_objet' => $row['id_document'],
                    'type' => 'image_du_jour',
                    'date_picked' => date('Y-m-d H:i:s')
                ));
            } else {
                // Une erreur est survenue (rubrique vide...)
            }
        }
    }

?>
<B_random>
    <div class="block-right block-image">
    <BOUCLE_random(spip_random) {type="image_du_jour"} {par date_picked} {inverse} {0,1}>
        <BOUCLE_img(DOCUMENTS) {id_document=#ID_OBJET}>
            <h2>
                <a class="seemore" href="#URL_PAGE{image,id_document=#ID_DOCUMENT}">L'image du jour <span class="icon"><i class="flaticon-plus"></i></span></a>
            </h2>
            <div>
                <a href="#URL_PAGE{image,id_document=#ID_DOCUMENT}">
                    [(#LOGO_DOCUMENT)]
                    [(#REM) [<div class="title">(#TITRE)</div>]]
                </a>
            </div>
        </BOUCLE_img>
    </BOUCLE_random>
    </div>
</B_random>